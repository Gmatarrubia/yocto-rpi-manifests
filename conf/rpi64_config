# /bin/sh

MACHINE=$1

source ./sources/poky/oe-init-build-env $MACHINE

bitbake-layers add-layer \
../sources/meta-raspberrypi \
../sources/meta-openembedded/meta-filesystems \
../sources/meta-openembedded/meta-oe \
../sources/meta-openembedded/meta-multimedia \
../sources/meta-openembedded/meta-networking \
../sources/meta-openembedded/meta-python \
../sources/meta-openembedded/meta-perl \
../sources/meta-security \
../sources/meta-clang \
../sources/meta-integration-extras \
../sources/meta-webthings

bitbake-layers add-layer \
../sources/meta-flutter

sed -i "s|MACHINE ??= \"qemux86-64\"|MACHINE ?= \"$MACHINE\"|g" conf/local.conf

cat <<EOT >> conf/local.conf

INHERIT:append = " rm_work"

BBMASK = "meta-networking/recipes-kernel/wireguard"

INIT_MANAGER = "systemd"
DISTRO_FEATURES:remove = "sysvinit x11 usbgadget"
DISTRO_FEATURES:append = " alsa bluetooth usbhost opengl wayland wifi pam security"

COMBINED_FEATURES += "alsa "
MACHINE_FEATURES:remove = "apm"

LINUX_KERNEL_TYPE = "preempt-rt"
CMDLINE_DEBUG = "quiet"

GPU_MEM = "128"
DISPMANX_OFFLINE = "1"
DISABLE_OVERSCAN = "1"

DISABLE_RPI_BOOT_LOGO = "1"
DISABLE_SPLASH = "1"

ENABLE_SPI_BUS = "1"
ENABLE_I2C = "1"
KERNEL_MODULE_AUTOLOAD:rpi += "i2c-dev i2c-bcm2708"
ENABLE_UART = "1"
# SERIAL_CONSOLES = "115200;ttyAMA0"

IMAGE_FEATURES:append = " splash package-management ssh-server-dropbear hwcodecs weston"
QB_MEM = "-m 512"

IMAGE_INSTALL:append = " \
  libgpiod-tools i2c-tools spidev-test can-utils \
  adwaita-icon-theme-cursors \
  xdg-user-dirs \
  tzdata-core \
  tzdata-americas \
  xkeyboard-config \
  default-language-en-us-utf8 \
  kernel-modules \
  wireless-regdb-static \
  avahi-daemon \
  userland \
  ntp ntp-tickadj \
  procps \
  bluez5 \
  bluez5-dev \
  bluez5-noinst-tools \
  bluez5-obex \
  bluez5-testtools \
  bluealsa \
  alsa-lib \
  alsa-conf \
  alsa-state \
  alsa-utils \
  alsa-utils-scripts \
  gstreamer1.0 \
  gstreamer1.0-meta-base \
  gstreamer1.0-omx \
  gstreamer1.0-plugins-bad \
  gstreamer1.0-plugins-base \
  gstreamer1.0-plugins-base-alsa \
  gstreamer1.0-plugins-good \
  gstreamer1.0-plugins-ugly \
  x264 \
  webthing-rust-examples \
"

LICENSE_FLAGS_ACCEPTED += " commercial"

PREFERRED_PROVIDER:jpeg = "libjpeg-turbo"
PREFERRED_PROVIDER:jpeg-native = "libjpeg-turbo-native"

EOT
